<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>Configurar Presupuesto</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      color: #1e1e1e;
      line-height: 1.5;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 1rem;
      width: 100%;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 0.8rem;
      border-bottom: 1px solid #e0e0e0;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .header h1 {
      font-size: 1.3rem;
      font-weight: 400;
      letter-spacing: 1px;
      color: #2c3e50;
    }

    .perfil-info {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      flex-wrap: wrap;
    }

    .perfil-badge {
      background: #f0f0f0;
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.85rem;
      color: #2c3e50;
      border: 1px solid #d0d0d0;
    }

    .btn-volver {
      padding: 0.4rem 0.8rem;
      background: white;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      color: #2c3e50;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }

    .btn-volver:hover {
      background: #f5f5f5;
      border-color: #a0a0a0;
    }

    /* Aviso */
    .aviso {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 0.8rem;
      margin-bottom: 1.5rem;
      text-align: center;
      font-size: 0.85rem;
      color: #5a6a7a;
    }

    /* Cards */
    .card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 1.2rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.02);
    }

    .card h2 {
      font-size: 1rem;
      font-weight: 400;
      margin-bottom: 1rem;
      color: #4a5568;
      letter-spacing: 0.3px;
    }

    .card h3 {
      font-size: 0.95rem;
      font-weight: 500;
      margin-bottom: 0.8rem;
      color: #2c3e50;
    }

    /* Categor√≠as */
    .categoria {
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: #fafafa;
      border: 1px solid #eaeaea;
      border-radius: 8px;
    }

    .categoria-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #e0e0e0;
    }

    .categoria-header span {
      font-size: 0.95rem;
      font-weight: 500;
      color: #2c3e50;
    }

    .subcategoria {
      display: flex;
      gap: 0.8rem;
      margin-bottom: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .subcategoria label {
      width: 80px;
      font-size: 0.85rem;
      color: #5a6a7a;
    }

    .subcategoria input {
      flex: 1;
      min-width: 150px;
      padding: 0.7rem;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 0.95rem;
      transition: border 0.2s;
      -webkit-appearance: none;
      appearance: none;
    }

    /* INPUT NUM√âRICO: elimina flechas y fuerza teclado num√©rico en m√≥vil */
    .subcategoria input[type="text"] {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    .subcategoria input:focus {
      outline: none;
      border-color: #2c3e50;
    }

    .btn-guardar {
      padding: 0.7rem 1.2rem;
      background: white;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      color: #2c3e50;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-guardar:hover {
      background: #f5f5f5;
      border-color: #909090;
    }

    /* Total presupuesto */
    .total-presupuesto {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      margin-top: 1.5rem;
    }

    .total-presupuesto .label {
      font-size: 0.85rem;
      color: #7f8c8d;
      margin-bottom: 0.3rem;
    }

    .total-presupuesto .valor {
      font-size: 1.8rem;
      font-weight: 300;
      color: #2c3e50;
      word-break: break-word;
    }

    /* Historial */
    .historial-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem 0;
      border-bottom: 1px solid #f0f0f0;
      font-size: 0.85rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .historial-item:last-child {
      border-bottom: none;
    }

    .historial-item .fecha {
      color: #95a5a6;
      font-size: 0.75rem;
      white-space: nowrap;
    }

    /* Mensajes */
    .mensaje {
      margin: 1rem 0;
      padding: 0.8rem;
      border-radius: 6px;
      font-size: 0.9rem;
      border: 1px solid;
      display: none;
      word-break: break-word;
    }

    .mensaje.exito {
      background: #f8f9fa;
      border-color: #c0c0c0;
      color: #2c3e50;
    }

    .mensaje.error {
      background: #fef5f5;
      border-color: #e0c0c0;
      color: #8b3a3a;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      color: #95a5a6;
      padding: 1.5rem 0;
      font-size: 0.9rem;
    }

    /* Nota importante */
    .nota {
      margin-top: 1rem;
      padding: 0.8rem;
      background: #f8f9fa;
      border: 1px solid #eaeaea;
      border-radius: 6px;
      font-size: 0.8rem;
      color: #5a6a7a;
      text-align: center;
    }

    /* Ajustes para m√≥vil peque√±o */
    @media (max-width: 480px) {
      .container {
        padding: 0.8rem;
      }
      
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .perfil-info {
        width: 100%;
        justify-content: space-between;
      }
      
      .subcategoria {
        flex-direction: column;
        align-items: stretch;
      }
      
      .subcategoria label {
        width: auto;
        margin-bottom: 0.2rem;
      }
      
      .subcategoria input {
        width: 100%;
      }
      
      .btn-guardar {
        width: 100%;
      }
      
      .total-presupuesto .valor {
        font-size: 1.6rem;
      }
      
      .historial-item {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .historial-item .fecha {
        align-self: flex-end;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>PRESUPUESTO</h1>
      <div class="perfil-info">
        <span class="perfil-badge" id="perfilDisplay">Cargando...</span>
        <button class="btn-volver" onclick="window.location.href='app.html'">‚Üê Volver</button>
      </div>
    </div>

    <div class="aviso">
      PRESUPUESTO GENERAL ¬∑ Compartido por Maria y Andres
    </div>

    <!-- Configuraci√≥n de presupuesto -->
    <div class="card">
      <h2>CONFIGURAR MENSUAL</h2>
      
      <!-- Mercado -->
      <div class="categoria">
        <div class="categoria-header">
          <span>üõí Mercado</span>
        </div>
        
        <div class="subcategoria">
          <label>Carnes</label>
          <!-- CAMBIO: inputmode="numeric" y pattern para teclado num√©rico -->
          <input type="text" id="presupuesto_mercado_carnes" placeholder="Monto" inputmode="numeric" pattern="\d*" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
          <button class="btn-guardar" onclick="guardarPresupuesto('Mercado', 'Carnes', 'presupuesto_mercado_carnes')">Guardar</button>
        </div>
        
        <div class="subcategoria">
          <label>Verduras</label>
          <input type="text" id="presupuesto_mercado_verduras" placeholder="Monto" inputmode="numeric" pattern="\d*" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
          <button class="btn-guardar" onclick="guardarPresupuesto('Mercado', 'Verduras', 'presupuesto_mercado_verduras')">Guardar</button>
        </div>
      </div>

      <!-- Servicios -->
      <div class="categoria">
        <div class="categoria-header">
          <span>üí° Servicios</span>
        </div>
        
        <div class="subcategoria">
          <label>Luz</label>
          <input type="text" id="presupuesto_servicios_luz" placeholder="Monto" inputmode="numeric" pattern="\d*" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
          <button class="btn-guardar" onclick="guardarPresupuesto('Servicios', 'Luz', 'presupuesto_servicios_luz')">Guardar</button>
        </div>
        
        <div class="subcategoria">
          <label>Gas</label>
          <input type="text" id="presupuesto_servicios_gas" placeholder="Monto" inputmode="numeric" pattern="\d*" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
          <button class="btn-guardar" onclick="guardarPresupuesto('Servicios', 'Gas', 'presupuesto_servicios_gas')">Guardar</button>
        </div>
      </div>

      <div class="total-presupuesto">
        <div class="label">TOTAL PRESUPUESTO MENSUAL</div>
        <div class="valor" id="totalPresupuesto">$0</div>
      </div>

      <div id="mensaje" class="mensaje"></div>
      
      <div class="nota">
        üí° Cada guardado acumula al presupuesto actual del mes
      </div>
    </div>

    <!-- Historial -->
    <div class="card">
      <h2>REGISTROS DEL MES</h2>
      <div id="historial">
        <div class="empty-state">Cargando...</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const db = getFirestore(initializeApp({
      apiKey: "AIzaSyDewpV6vxTMevSNzU4jCP7XYTZj_jlx4-Y",
      authDomain: "controlgastosprueba.firebaseapp.com",
      projectId: "controlgastosprueba",
      storageBucket: "controlgastosprueba.firebasestorage.app",
      messagingSenderId: "679682152121",
      appId: "1:679682152121:web:d3981591d952df1333ed68"
    }));

    const perfil = sessionStorage.getItem('perfil');
    
    if (!perfil || perfil === 'Admin') {
      window.location.href = "index.html";
    }

    document.getElementById('perfilDisplay').innerText = perfil;

    window.guardarPresupuesto = async (categoria, subcategoria, inputId) => {
      const monto = parseFloat(document.getElementById(inputId).value);
      
      if (isNaN(monto) || monto <= 0) {
        mostrarMensaje("Ingresa un monto v√°lido", "error");
        return;
      }

      try {
        await addDoc(collection(db, "presupuestos"), {
          usuario: 'GENERAL',
          categoria: categoria,
          subcategoria: subcategoria,
          monto: monto,
          fecha: new Date(),
          mes: new Date().getMonth() + 1,
          a√±o: new Date().getFullYear()
        });
        
        mostrarMensaje(`Presupuesto actualizado: ${categoria} - ${subcategoria} $${monto}`, "exito");
        document.getElementById(inputId).value = '';
        cargarHistorial();
        calcularTotalPresupuesto();
      } catch (error) {
        console.error(error);
        mostrarMensaje("Error al guardar", "error");
      }
    };

    function mostrarMensaje(texto, tipo) {
      const mensaje = document.getElementById('mensaje');
      mensaje.style.display = 'block';
      mensaje.innerText = texto;
      mensaje.className = `mensaje ${tipo}`;
      setTimeout(() => {
        mensaje.style.display = 'none';
      }, 3000);
    }

    async function cargarHistorial() {
      try {
        const mesActual = new Date().getMonth() + 1;
        const a√±oActual = new Date().getFullYear();
        
        const q = query(
          collection(db, "presupuestos"), 
          where("usuario", "==", 'GENERAL'),
          where("mes", "==", mesActual),
          where("a√±o", "==", a√±oActual),
          orderBy("fecha", "desc")
        );
        
        const querySnapshot = await getDocs(q);
        
        const historial = document.getElementById("historial");
        
        if (querySnapshot.empty) {
          historial.innerHTML = '<div class="empty-state">No hay registros este mes</div>';
          return;
        }

        historial.innerHTML = '';
        querySnapshot.forEach(doc => {
          const data = doc.data();
          const fecha = data.fecha.toDate ? data.fecha.toDate() : new Date();
          const div = document.createElement("div");
          div.className = "historial-item";
          div.innerHTML = `
            <span><strong>${data.categoria} - ${data.subcategoria}:</strong> $${data.monto}</span>
            <span class="fecha">${fecha.toLocaleDateString()}</span>
          `;
          historial.appendChild(div);
        });
      } catch (error) {
        console.error(error);
      }
    }

    async function calcularTotalPresupuesto() {
      try {
        const mesActual = new Date().getMonth() + 1;
        const a√±oActual = new Date().getFullYear();
        
        const q = query(
          collection(db, "presupuestos"), 
          where("usuario", "==", 'GENERAL'),
          where("mes", "==", mesActual),
          where("a√±o", "==", a√±oActual)
        );
        
        const querySnapshot = await getDocs(q);
        let total = 0;
        
        querySnapshot.forEach(doc => {
          total += doc.data().monto || 0;
        });
        
        document.getElementById('totalPresupuesto').innerText = `$${total}`;
      } catch (error) {
        console.error(error);
      }
    }

    cargarHistorial();
    calcularTotalPresupuesto();
  </script>
</body>
</html>

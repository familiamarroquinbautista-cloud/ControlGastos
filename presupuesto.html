<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Configurar Presupuesto</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      color: #1e1e1e;
      line-height: 1.5;
    }

    .container {
      max-width: 600px;
      margin: 2rem auto;
      padding: 0 1.5rem;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #e0e0e0;
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 400;
      letter-spacing: 1px;
      color: #2c3e50;
    }

    .perfil-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .perfil-badge {
      background: #f0f0f0;
      padding: 0.4rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      color: #2c3e50;
      border: 1px solid #d0d0d0;
    }

    .btn-volver {
      padding: 0.5rem 1rem;
      background: white;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      color: #2c3e50;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }

    .btn-volver:hover {
      background: #f5f5f5;
      border-color: #a0a0a0;
    }

    .aviso {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 0.8rem;
      margin-bottom: 1.5rem;
      text-align: center;
      font-size: 0.9rem;
      color: #5a6a7a;
    }

    .card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.02);
    }

    .card h2 {
      font-size: 1.1rem;
      font-weight: 400;
      margin-bottom: 1.2rem;
      color: #4a5568;
      letter-spacing: 0.3px;
    }

    .card h3 {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 1rem;
      color: #2c3e50;
    }

    .categoria {
      margin-bottom: 2rem;
      padding: 1rem;
      background: #fafafa;
      border: 1px solid #eaeaea;
      border-radius: 8px;
    }

    .categoria-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.2rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #e0e0e0;
    }

    .categoria-header span {
      font-size: 1rem;
      font-weight: 500;
      color: #2c3e50;
    }

    .subcategoria {
      display: flex;
      gap: 0.8rem;
      margin-bottom: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .subcategoria label {
      width: 80px;
      font-size: 0.9rem;
      color: #5a6a7a;
    }

    .subcategoria input {
      flex: 1;
      min-width: 150px;
      padding: 0.8rem;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 0.9rem;
      transition: border 0.2s;
    }

    .subcategoria input:focus {
      outline: none;
      border-color: #2c3e50;
    }

    .subcategoria input[type="number"] {
      width: 120px;
      flex: 0 1 auto;
    }

    .btn-guardar {
      padding: 0.8rem 1.2rem;
      background: white;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      color: #2c3e50;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-guardar:hover {
      background: #f5f5f5;
      border-color: #909090;
    }

    .total-presupuesto {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 1.2rem;
      text-align: center;
      margin-top: 1.5rem;
    }

    .total-presupuesto .label {
      font-size: 0.9rem;
      color: #7f8c8d;
      margin-bottom: 0.5rem;
    }

    .total-presupuesto .valor {
      font-size: 2rem;
      font-weight: 300;
      color: #2c3e50;
    }

    .historial-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem 0;
      border-bottom: 1px solid #f0f0f0;
      font-size: 0.9rem;
    }

    .historial-item:last-child {
      border-bottom: none;
    }

    .historial-item .fecha {
      color: #95a5a6;
      font-size: 0.8rem;
    }

    .mensaje {
      margin: 1rem 0;
      padding: 0.8rem;
      border-radius: 6px;
      font-size: 0.9rem;
      border: 1px solid;
      display: none;
    }

    .mensaje.exito {
      background: #f8f9fa;
      border-color: #c0c0c0;
      color: #2c3e50;
    }

    .mensaje.error {
      background: #fef5f5;
      border-color: #e0c0c0;
      color: #8b3a3a;
    }

    .empty-state {
      text-align: center;
      color: #95a5a6;
      padding: 2rem 0;
      font-size: 0.9rem;
    }

    .nota {
      margin-top: 1rem;
      padding: 0.8rem;
      background: #f8f9fa;
      border: 1px solid #eaeaea;
      border-radius: 6px;
      font-size: 0.85rem;
      color: #5a6a7a;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>PRESUPUESTO</h1>
      <div class="perfil-info">
        <span class="perfil-badge" id="perfilDisplay">Cargando...</span>
        <button class="btn-volver" onclick="window.location.href='app.html'">← Volver</button>
      </div>
    </div>

    <div class="aviso">
      PRESUPUESTO GENERAL - Compartido por Maria y Andres
    </div>

    <div class="card">
      <h2>CONFIGURAR MENSUAL</h2>
      
      <div class="categoria">
        <div class="categoria-header">
          <span> Mercado</span>
        </div>
        
        <div class="subcategoria">
          <label>Carnes</label>
          <input type="number" id="presupuesto_mercado_carnes" placeholder="Monto" min="0">
          <button class="btn-guardar" onclick="guardarPresupuesto('Mercado', 'Carnes', 'presupuesto_mercado_carnes')">Guardar</button>
        </div>
        
        <div class="subcategoria">
          <label>Verduras</label>
          <input type="number" id="presupuesto_mercado_verduras" placeholder="Monto" min="0">
          <button class="btn-guardar" onclick="guardarPresupuesto('Mercado', 'Verduras', 'presupuesto_mercado_verduras')">Guardar</button>
        </div>

        <div class="subcategoria">
          <label>Lacteos</label>
          <input type="number" id="presupuesto_mercado_lacteos" placeholder="Monto" min="0">
          <button class="btn-guardar" onclick="guardarPresupuesto('Mercado', 'Lacteos', 'presupuesto_mercado_lacteos')">Guardar</button>
        </div>

        <div class="subcategoria">
          <label>Abarrotes</label>
          <input type="number" id="presupuesto_mercado_abarrotes" placeholder="Monto" min="0">
          <button class="btn-guardar" onclick="guardarPresupuesto('Mercado', 'Abarrotes', 'presupuesto_mercado_abarrotes')">Guardar</button>
        </div>

        <div class="subcategoria">
          <label>Frutas</label>
          <input type="number" id="presupuesto_mercado_frutas" placeholder="Monto" min="0">
          <button class="btn-guardar" onclick="guardarPresupuesto('Mercado', 'Frutas', 'presupuesto_mercado_frutas')">Guardar</button>
        </div>

        <div class="subcategoria">
          <label>Limpieza</label>
          <input type="number" id="presupuesto_mercado_limpieza" placeholder="Monto" min="0">
          <button class="btn-guardar" onclick="guardarPresupuesto('Mercado', 'Limpieza', 'presupuesto_mercado_limpieza')">Guardar</button>
        </div>
      </div>

      <div class="categoria">
        <div class="categoria-header">
          <span> Servicios</span>
        </div>
        
        <div class="subcategoria">
          <label>Luz</label>
          <input type="number" id="presupuesto_servicios_luz" placeholder="Monto" min="0">
          <button class="btn-guardar" onclick="guardarPresupuesto('Servicios', 'Luz', 'presupuesto_servicios_luz')">Guardar</button>
        </div>
        
        <div class="subcategoria">
          <label>Gas</label>
          <input type="number" id="presupuesto_servicios_gas" placeholder="Monto" min="0">
          <button class="btn-guardar" onclick="guardarPresupuesto('Servicios', 'Gas', 'presupuesto_servicios_gas')">Guardar</button>
        </div>

        <div class="subcategoria">
          <label>Agua</label>
          <input type="number" id="presupuesto_servicios_agua" placeholder="Monto" min="0">
          <button class="btn-guardar" onclick="guardarPresupuesto('Servicios', 'Agua', 'presupuesto_servicios_agua')">Guardar</button>
        </div>

        <div class="subcategoria">
          <label>Internet</label>
          <input type="number" id="presupuesto_servicios_internet" placeholder="Monto" min="0">
          <button class="btn-guardar" onclick="guardarPresupuesto('Servicios', 'Internet', 'presupuesto_servicios_internet')">Guardar</button>
        </div>

        <div class="subcategoria">
          <label>Telefono</label>
          <input type="number" id="presupuesto_servicios_telefono" placeholder="Monto" min="0">
          <button class="btn-guardar" onclick="guardarPresupuesto('Servicios', 'Telefono', 'presupuesto_servicios_telefono')">Guardar</button>
        </div>

        <div class="subcategoria">
          <label>Gasolina</label>
          <input type="number" id="presupuesto_servicios_gasolina" placeholder="Monto" min="0">
          <button class="btn-guardar" onclick="guardarPresupuesto('Servicios', 'Gasolina', 'presupuesto_servicios_gasolina')">Guardar</button>
        </div>
      </div>

      <div class="total-presupuesto">
        <div class="label">TOTAL PRESUPUESTO MENSUAL</div>
        <div class="valor" id="totalPresupuesto">$0</div>
      </div>

      <div id="mensaje" class="mensaje"></div>
      
      <div class="nota">
        Cada guardado actualiza el presupuesto de la subcategoria para el mes actual
      </div>
    </div>

    <div class="card">
      <h2>REGISTROS DEL MES</h2>
      <div id="historial">
        <div class="empty-state">Cargando...</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from './firebase-config.js';
    import { collection, addDoc, getDocs, updateDoc, doc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const perfil = sessionStorage.getItem('perfil');
    
    if (!perfil || perfil === 'Admin') {
      window.location.href = "index.html";
    }

    document.getElementById('perfilDisplay').innerText = perfil;

    window.guardarPresupuesto = async (categoria, subcategoria, inputId) => {
      const monto = parseFloat(document.getElementById(inputId).value);
      
      if (isNaN(monto) || monto <= 0) {
        mostrarMensaje("Ingresa un monto valido", "error");
        return;
      }

      try {
        const mesActual = new Date().getMonth() + 1;
        const añoActual = new Date().getFullYear();
        
        const q = query(
          collection(db, "presupuestos"),
          where("categoria", "==", categoria),
          where("subcategoria", "==", subcategoria),
          where("mes", "==", mesActual),
          where("año", "==", añoActual)
        );
        
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
          await addDoc(collection(db, "presupuestos"), {
            usuario: 'GENERAL',
            categoria: categoria,
            subcategoria: subcategoria,
            monto: monto,
            fecha: new Date(),
            mes: mesActual,
            año: añoActual
          });
        } else {
          const docId = snapshot.docs[0].id;
          await updateDoc(doc(db, "presupuestos", docId), {
            monto: monto,
            fecha: new Date()
          });
        }
        
        mostrarMensaje(`Presupuesto actualizado: ${categoria} - ${subcategoria} $${monto}`, "exito");
        document.getElementById(inputId).value = '';
        cargarHistorial();
        calcularTotalPresupuesto();
      } catch (error) {
        console.error(error);
        mostrarMensaje("Error al guardar", "error");
      }
    };

    function mostrarMensaje(texto, tipo) {
      const mensaje = document.getElementById('mensaje');
      mensaje.style.display = 'block';
      mensaje.innerText = texto;
      mensaje.className = `mensaje ${tipo}`;
      setTimeout(() => {
        mensaje.style.display = 'none';
      }, 3000);
    }

    async function cargarHistorial() {
      try {
        const mesActual = new Date().getMonth() + 1;
        const añoActual = new Date().getFullYear();
        
        const q = query(
          collection(db, "presupuestos"), 
          where("usuario", "==", 'GENERAL'),
          where("mes", "==", mesActual),
          where("año", "==", añoActual),
          orderBy("fecha", "desc")
        );
        
        const querySnapshot = await getDocs(q);
        
        const historial = document.getElementById("historial");
        
        if (querySnapshot.empty) {
          historial.innerHTML = '<div class="empty-state">No hay registros este mes</div>';
          return;
        }

        historial.innerHTML = '';
        querySnapshot.forEach(doc => {
          const data = doc.data();
          const fecha = data.fecha?.toDate ? data.fecha.toDate() : new Date();
          const div = document.createElement("div");
          div.className = "historial-item";
          div.innerHTML = `
            <span><strong>${data.categoria} - ${data.subcategoria}:</strong> $${data.monto}</span>
            <span class="fecha">${fecha.toLocaleDateString()}</span>
          `;
          historial.appendChild(div);
        });
      } catch (error) {
        console.error(error);
      }
    }

    async function calcularTotalPresupuesto() {
      try {
        const mesActual = new Date().getMonth() + 1;
        const añoActual = new Date().getFullYear();
        
        const q = query(
          collection(db, "presupuestos"), 
          where("usuario", "==", 'GENERAL'),
          where("mes", "==", mesActual),
          where("año", "==", añoActual)
        );
        
        const querySnapshot = await getDocs(q);
        let total = 0;
        const categoriasVistas = new Set();
        
        querySnapshot.forEach(doc => {
          const data = doc.data();
          const key = `${data.categoria}_${data.subcategoria}`;
          
          if (!categoriasVistas.has(key)) {
            total += data.monto || 0;
            categoriasVistas.add(key);
          }
        });
        
        document.getElementById('totalPresupuesto').innerText = `$${total}`;
      } catch (error) {
        console.error(error);
      }
    }

    cargarHistorial();
    calcularTotalPresupuesto();
  </script>
</body>
</html>

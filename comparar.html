<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Comparar vs Presupuesto</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      color: #1e1e1e;
      line-height: 1.5;
    }

    .container {
      max-width: 600px;
      margin: 2rem auto;
      padding: 0 1.5rem;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #e0e0e0;
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 400;
      letter-spacing: 1px;
      color: #2c3e50;
    }

    .perfil-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .perfil-badge {
      background: #f0f0f0;
      padding: 0.4rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      color: #2c3e50;
      border: 1px solid #d0d0d0;
    }

    .btn-volver {
      padding: 0.5rem 1rem;
      background: white;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      color: #2c3e50;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }

    .btn-volver:hover {
      background: #f5f5f5;
      border-color: #a0a0a0;
    }

    /* Aviso */
    .aviso {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 0.8rem;
      margin-bottom: 1.5rem;
      text-align: center;
      font-size: 0.9rem;
      color: #5a6a7a;
    }

    /* Card */
    .card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.02);
    }

    .card h2 {
      font-size: 1.1rem;
      font-weight: 400;
      margin-bottom: 1.2rem;
      color: #4a5568;
      letter-spacing: 0.3px;
    }

    /* Resumen general */
    .resumen-general {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .resumen-general .label {
      font-size: 0.9rem;
      color: #7f8c8d;
      margin-bottom: 0.5rem;
    }

    .resumen-general .valores {
      font-size: 2rem;
      font-weight: 300;
      color: #2c3e50;
      margin-bottom: 0.5rem;
    }

    .resumen-general .diferencia {
      display: inline-block;
      padding: 0.3rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
    }

    .diferencia.positivo {
      background: #f0f7f0;
      border-color: #c0d0c0;
      color: #2c5a2c;
    }

    .diferencia.negativo {
      background: #fcf0f0;
      border-color: #e0c0c0;
      color: #8b3a3a;
    }

    /* Categorías */
    .categoria {
      margin-bottom: 1.5rem;
      border: 1px solid #eaeaea;
      border-radius: 8px;
      overflow: hidden;
    }

    .categoria-header {
      background: #f8f9fa;
      padding: 0.8rem 1rem;
      font-weight: 500;
      border-bottom: 1px solid #eaeaea;
      color: #2c3e50;
    }

    .subcategoria {
      padding: 1rem;
      border-bottom: 1px solid #f0f0f0;
    }

    .subcategoria:last-child {
      border-bottom: none;
    }

    .subcategoria-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .subcategoria-nombre {
      font-weight: 500;
      color: #4a5568;
    }

    .diferencia-badge {
      padding: 0.2rem 0.8rem;
      border-radius: 20px;
      font-size: 0.8rem;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
    }

    .diferencia-badge.positivo {
      background: #f0f7f0;
      border-color: #c0d0c0;
      color: #2c5a2c;
    }

    .diferencia-badge.negativo {
      background: #fcf0f0;
      border-color: #e0c0c0;
      color: #8b3a3a;
    }

    .valores {
      display: flex;
      gap: 1.5rem;
      font-size: 0.9rem;
    }

    .presupuesto {
      color: #7f8c8d;
    }

    .gasto {
      color: #2c3e50;
      font-weight: 500;
    }

    .total-row {
      background: #f8f9fa;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      font-weight: 500;
      border-top: 1px solid #e0e0e0;
      color: #2c3e50;
    }

    /* Recomendaciones */
    .recomendaciones {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      font-size: 0.95rem;
      color: #5a6a7a;
    }

    /* Estados */
    .empty-state {
      text-align: center;
      color: #95a5a6;
      padding: 2rem;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>COMPARAR</h1>
      <div class="perfil-info">
        <span class="perfil-badge" id="perfilDisplay">Cargando...</span>
        <button class="btn-volver" onclick="window.location.href='app.html'">← Volver</button>
      </div>
    </div>

    <div class="aviso">
      Presupuesto GENERAL vs gastos personales
    </div>

    <!-- Resumen general -->
    <div class="resumen-general">
      <div class="label">RESUMEN DEL MES</div>
      <div class="valores" id="totalGeneral">$0 vs $0</div>
      <div id="diferenciaGeneral" class="diferencia">Cargando...</div>
    </div>

    <!-- Comparación por categorías -->
    <div class="card">
      <h2>POR CATEGORÍA</h2>
      <div id="comparacionContainer">
        <div class="empty-state">Cargando datos...</div>
      </div>
    </div>

    <!-- Recomendaciones -->
    <div class="card">
      <h2>RECOMENDACIONES</h2>
      <div id="recomendaciones" class="recomendaciones">
        Cargando...
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const db = getFirestore(initializeApp({
      apiKey: "AIzaSyDewpV6vxTMevSNzU4jCP7XYTZj_jlx4-Y",
      authDomain: "controlgastosprueba.firebaseapp.com",
      projectId: "controlgastosprueba",
      storageBucket: "controlgastosprueba.firebasestorage.app",
      messagingSenderId: "679682152121",
      appId: "1:679682152121:web:d3981591d952df1333ed68"
    }));

    const perfil = sessionStorage.getItem('perfil');
    
    if (!perfil || perfil === 'Admin') {
      window.location.href = "index.html";
    }

    document.getElementById('perfilDisplay').innerText = perfil;

    const categorias = {
      'Mercado': ['Carnes', 'Verduras'],
      'Servicios': ['Luz', 'Gas']
    };

    async function cargarComparacion() {
      try {
        const mesActual = new Date().getMonth() + 1;
        const añoActual = new Date().getFullYear();
        
        // Obtener presupuesto GENERAL
        const presupuestosQuery = query(
          collection(db, "presupuestos"),
          where("usuario", "==", 'GENERAL'),
          where("mes", "==", mesActual),
          where("año", "==", añoActual)
        );
        const presupuestosSnap = await getDocs(presupuestosQuery);
        
        // Obtener gastos del perfil actual
        const gastosQuery = query(
          collection(db, "gastos"),
          where("usuario", "==", perfil),
          where("mes", "==", mesActual),
          where("año", "==", añoActual)
        );
        const gastosSnap = await getDocs(gastosQuery);

        // Organizar datos
        const presupuestos = {};
        presupuestosSnap.forEach(doc => {
          const data = doc.data();
          const key = `${data.categoria}_${data.subcategoria}`;
          presupuestos[key] = (presupuestos[key] || 0) + data.monto;
        });

        const gastos = {};
        gastosSnap.forEach(doc => {
          const data = doc.data();
          const key = `${data.categoria}_${data.subcategoria}`;
          gastos[key] = (gastos[key] || 0) + data.monto;
        });

        const container = document.getElementById('comparacionContainer');
        container.innerHTML = '';

        let totalPresupuesto = 0;
        let totalGastos = 0;

        for (const [categoria, subcategorias] of Object.entries(categorias)) {
          const categoriaDiv = document.createElement('div');
          categoriaDiv.className = 'categoria';
          
          categoriaDiv.innerHTML = `<div class="categoria-header">${categoria}</div>`;

          let totalCatPresupuesto = 0;
          let totalCatGasto = 0;

          for (const subcategoria of subcategorias) {
            const key = `${categoria}_${subcategoria}`;
            const presupuesto = presupuestos[key] || 0;
            const gasto = gastos[key] || 0;
            const diferencia = presupuesto - gasto;

            totalCatPresupuesto += presupuesto;
            totalCatGasto += gasto;
            totalPresupuesto += presupuesto;
            totalGastos += gasto;

            let diferenciaClass = '';
            let diferenciaText = 'Sin presupuesto';
            
            if (presupuesto > 0) {
              diferenciaClass = diferencia >= 0 ? 'positivo' : 'negativo';
              diferenciaText = diferencia >= 0 ? `Ahorro $${diferencia}` : `Exceso $${Math.abs(diferencia)}`;
            }

            const subDiv = document.createElement('div');
            subDiv.className = 'subcategoria';
            subDiv.innerHTML = `
              <div class="subcategoria-header">
                <span class="subcategoria-nombre">${subcategoria}</span>
                <span class="diferencia-badge ${diferenciaClass}">${diferenciaText}</span>
              </div>
              <div class="valores">
                <span class="presupuesto">Presupuesto: $${presupuesto}</span>
                <span class="gasto">Gastado: $${gasto}</span>
              </div>
            `;
            categoriaDiv.appendChild(subDiv);
          }

          // Total por categoría
          const totalCatDiv = document.createElement('div');
          totalCatDiv.className = 'total-row';
          totalCatDiv.innerHTML = `
            <span>Total ${categoria}</span>
            <span>$${totalCatPresupuesto} / $${totalCatGasto}</span>
          `;
          categoriaDiv.appendChild(totalCatDiv);

          container.appendChild(categoriaDiv);
        }

        // Actualizar resumen general
        document.getElementById('totalGeneral').innerHTML = `$${totalPresupuesto} vs $${totalGastos}`;
        
        const diferenciaGeneral = totalPresupuesto - totalGastos;
        const diferenciaElement = document.getElementById('diferenciaGeneral');
        
        if (totalPresupuesto === 0) {
          diferenciaElement.innerText = 'Sin presupuesto configurado';
          diferenciaElement.className = 'diferencia';
        } else if (diferenciaGeneral >= 0) {
          diferenciaElement.innerText = `Disponible: $${diferenciaGeneral}`;
          diferenciaElement.className = 'diferencia positivo';
        } else {
          diferenciaElement.innerText = `Déficit: $${Math.abs(diferenciaGeneral)}`;
          diferenciaElement.className = 'diferencia negativo';
        }

        // Recomendaciones
        const recomendaciones = document.getElementById('recomendaciones');
        if (totalPresupuesto === 0) {
          recomendaciones.innerHTML = 'Configura un presupuesto en el módulo correspondiente.';
        } else if (totalGastos === 0) {
          recomendaciones.innerHTML = 'No has registrado gastos este mes.';
        } else if (diferenciaGeneral >= 0) {
          const porcentaje = ((totalGastos / totalPresupuesto) * 100).toFixed(1);
          recomendaciones.innerHTML = `Has usado el ${porcentaje}% del presupuesto. Saldo disponible: $${diferenciaGeneral}.`;
        } else {
          recomendaciones.innerHTML = `Has excedido el presupuesto en $${Math.abs(diferenciaGeneral)}. Revisa tus gastos.`;
        }

      } catch (error) {
        console.error(error);
        document.getElementById('comparacionContainer').innerHTML = '<div class="empty-state">Error al cargar datos</div>';
      }
    }

    cargarComparacion();
  </script>
</body>
</html>
